üß© PART 1 ‚Äì Updated Context + Exact Error
You are an expert full‚Äëstack engineer (Next.js or React/Vite, Firebase v9, Firestore, Vercel).

My ecommerce site (PakCart.store style) has:

Checkout steps: Cart ‚Üí Information ‚Üí Payment ‚Üí Confirmation
Tech stack:
Frontend: Next.js App Router or React + Vite (please detect)
Styling: Tailwind CSS + Shadcn/UI
Auth: Firebase Auth v9+
Database: Firestore
Deployment: Vercel
Repo info:

Repo: <REPO_URL>
Root path in Replit (if not /): <PROJECT_PATH>
Main bug right now
On the Payment step, when I click ‚ÄúComplete Order‚Äù (COD selected), I get this exact error toast:

Error ‚Äì Failed to execute 'json' on 'Response': Unexpected end of JSON input

Screenshot:
https://www.genspark.ai/api/files/s/vh9sB0Vm

This means my frontend is doing await res.json() but the response has no JSON body or invalid JSON.

Also:

Orders still don‚Äôt show up in the admin orders panel.
I also have a separate reviews/comment system problem (reviews not appearing after ‚ÄúComment added successfully‚Äù), but for now, focus first on the Complete Order error and admin orders.
First, please:

Detect whether this is a Next.js App Router or Vite/React app.
Locate:
The component/page with the Payment step and ‚ÄúComplete Order‚Äù button.
Any order‚Äëcreation API routes (e.g. app/api/orders/route.ts, pages/api/orders.ts, etc.).
Admin pages related to orders: /admin/orders, /admin/orders/[id] or similar.
The Firebase / Firestore config file(s).
List the key files and routes where you see the checkout and order logic.

üß© PART 2 ‚Äì Fix the ‚ÄúUnexpected end of JSON input‚Äù & Order Creation
In this part, I want you to fully fix the order creation API and the frontend call so this JSON error disappears and valid orders are saved.

1. Find the ‚ÄúComplete Order‚Äù handler and API call
In the Payment step component, find the function called when clicking ‚ÄúComplete Order‚Äù (e.g. handleCompleteOrder, onCompleteOrder, placeOrder).

See exactly how it calls the backend:

URL (e.g. /api/orders, /api/order/create)
HTTP method
Body (JSON.stringify({ ... }))
How it handles the response (await res.json()).
Add temporary console logs:

Copyconsole.log("DEBUG completeOrder payload:", payload);
console.log("DEBUG completeOrder response status:", res.status);
const text = await res.text();
console.log("DEBUG completeOrder raw response text:", text);
‚Ä¶but then replace that with the proper res.json() pattern once you know what the API returns.

2. Fix the API route / backend handler
Find the matching API route or backend code:

For App Router: app/api/orders/route.ts (or similar)
For pages router: pages/api/orders.ts
Or any custom server function.
Common cause of this error: the route returns no body for some status codes (e.g. return new Response(null, { status: 500 })) while the client always expects JSON.

Fix the route so that every code path returns valid JSON:

Example for App Router (app/api/orders/route.ts):

Copyimport { NextResponse } from "next/server";
import { db } from "@/lib/firebase";
import { collection, addDoc, serverTimestamp, doc, setDoc } from "firebase/firestore";

export async function POST(request: Request) {
  try {
    const body = await request.json();
    const { userId, cartItems, paymentMethod, shippingAddress, totals } = body;

    // Validate required fields
    if (!userId || !cartItems?.length || !paymentMethod || !totals) {
      return NextResponse.json(
        { success: false, message: "Missing required fields" },
        { status: 400 }
      );
    }

    // 1) Create main order document
    const orderRef = await addDoc(collection(db, "orders"), {
      userId,
      status: "pending",
      paymentMethod,
      subtotal: totals.subtotal,
      shipping: totals.shipping,
      total: totals.total,
      shippingAddress,
      createdAt: serverTimestamp(),
    });

    // 2) Create order items
    const writes = cartItems.map((item: any) =>
      setDoc(doc(db, "orders", orderRef.id, "items", item.id), {
        productId: item.id,
        title: item.title,
        quantity: item.quantity,
        price: item.price,
        image: item.image,
      })
    );
    await Promise.all(writes);

    return NextResponse.json(
      { success: true, orderId: orderRef.id },
      { status: 201 }
    );
  } catch (error) {
    console.error("DEBUG create order error:", error);
    return NextResponse.json(
      { success: false, message: "Failed to create order" },
      { status: 500 }
    );
  }
}
Copy
If your route is currently returning nothing or HTML (like a 500 error page), adjust it to always return JSON as above.

Check Firestore:

Ensure you‚Äôre using the correct db import (modular v9).
Ensure collection path is consistent: orders and orders/{orderId}/items.
3. Fix the frontend response handling
Once the API guarantees JSON, simplify the client:

CopysetIsSubmitting(true);
try {
  const res = await fetch("/api/orders", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload),
  });

  const data = await res.json(); // now safe because server always returns JSON

  if (!res.ok || !data.success) {
    throw new Error(data.message || "Order failed");
  }

  // Success:
  // - clear cart
  // - show success toast
  // - redirect to confirmation page, e.g. `/order-success/${data.orderId}`
} catch (error) {
  console.error("DEBUG completeOrder error:", error);
  // show red toast with error message
} finally {
  setIsSubmitting(false);
}
If you decide to sometimes return no content (e.g. 204), then change the client to:

Copyconst text = await res.text();
const data = text ? JSON.parse(text) : null;
‚Ä¶but the simplest solution is: always return JSON from the API.

4. Confirm the error is gone and orders are created
After your changes:

Clicking Complete Order should no longer show the Unexpected end of JSON input error.
A new document should appear in Firestore under orders, with an items subcollection.
If any Firestore permission error appears (Missing or insufficient permissions), adjust Firestore rules so authenticated users can create orders.

üß© PART 3 ‚Äì Admin Orders Panel + Final Checks
Now that orders are successfully created, ensure the admin panel displays them.

1. Wire admin list and details to the actual schema
Find admin routes/components:

Orders list: e.g. app/admin/orders/page.tsx
Order details: e.g. app/admin/orders/[id]/page.tsx or similar.
Make sure they query the same paths you just used for creation:

List:

Copyconst q = query(collection(db, "orders"), orderBy("createdAt", "desc"));
const snap = await getDocs(q);
const orders = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
Details:

Copyconst orderDoc = await getDoc(doc(db, "orders", orderId));
const itemsSnap = await getDocs(collection(db, "orders", orderId, "items"));
const items = itemsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
Ensure the UI shows:
Order ID
User info (userId/email)
Status
Payment method
Totals (subtotal, shipping, total)
Shipping address
Items list (title, quantity, price, line total)
2. Access control and Firestore rules
See how the project identifies admins (custom claims, Firestore role doc, env list).
Ensure:
Only admins can access the admin routes client‚Äëside.
Firestore rules allow admins to read all orders. Example pattern:
function isAdmin() {
  return request.auth != null && request.auth.token.admin == true;
}

match /orders/{orderId} {
  allow create: if request.auth != null
    && request.resource.data.userId == request.auth.uid;
  allow read: if isAdmin() || (request.auth != null
    && resource.data.userId == request.auth.uid);
}

match /orders/{orderId}/items/{itemId} {
  allow create: if request.auth != null
    && get(/databases/$(database)/documents/orders/$(orderId)).data.userId
       == request.auth.uid;
  allow read: if isAdmin() || (request.auth != null
    && get(/databases/$(database)/documents/orders/$(orderId)).data.userId
       == request.auth.uid);
}
Explain any assumptions you make (e.g. admin users must be given admin: true custom claim).

3. Short report & remaining issues
When you‚Äôre done, please give me:

Root cause of the Unexpected end of JSON input error
(e.g. ‚ÄúAPI route returned empty body/HTML on error while client always called res.json()‚Äù).
Files and key snippets changed:
API route for orders
Payment / Complete Order handler
Admin orders queries
Confirmation that:
Orders are created in Firestore.
No JSON parse error occurs.
Orders and their items appear correctly in the admin panel.