Part 32.4: Social Authentication Integration (Divided into 3 Parts)
Part 32.4a: Google Sign-In UI Implementation and Authentication Flow
Objective: Implement Google Sign-In button with proper branding, visual hierarchy, and comprehensive authentication handler with error management optimized for Pakistani users.

Add the Google Sign-In button below the main registration form using the SocialAuthButton component created in Part 31. Position this social authentication section strategically after the primary email/password registration form to maintain visual hierarchy and user flow. Create a professional visual divider between the two authentication methods using a flex container with two horizontal lines (border-t border-gray-300) separated by centered "OR" text, ensuring the divider spans the full form width while maintaining consistent spacing with surrounding elements.

Style the Google Sign-In button following official Google Identity branding guidelines with meticulous attention to detail. Use the authentic Google "G" logo (either as an SVG or from Google's official CDN), implement the exact "Continue with Google" text as specified in Google's branding requirements, apply Google's official color scheme with white background (bg-white), dark text color (text-gray-700), and subtle border (border border-gray-300). Add proper hover states using hover:bg-gray-50 for subtle feedback and hover:shadow-md for depth, ensuring the button maintains Google's professional appearance while integrating seamlessly with your site's design system.

Implement the comprehensive Google Sign-In handler function triggered when users click the authentication button. Create a GoogleAuthProvider instance if not already configured globally and call Firebase's signInWithPopup(auth, googleProvider) function wrapped in a detailed try-catch block for robust error handling across various authentication scenarios that Pakistani users might encounter.

Handle popup blocked scenarios specifically by catching the "auth/popup-blocked" error code and displaying a user-friendly, actionable error message: "Pop-up was blocked by your browser. Please allow pop-ups for this site in your browser settings and try again." Include browser-specific instructions for Chrome (most common in Pakistan), Firefox, and Safari showing users exactly how to enable pop-ups. Add a "Try Again" button allowing users to retry authentication after enabling pop-ups, improving conversion rates by reducing friction.

Implement comprehensive error handling for additional Google authentication scenarios that commonly occur in Pakistani network conditions. Catch "auth/popup-closed-by-user" when users close the popup before completing authentication and display a gentle message "Sign-in was cancelled. Click the button to try again when you're ready." Handle "auth/account-exists-with-different-credential" when an email is already registered with different method by showing "An account already exists with this email using a different sign-in method. Please use your original sign-in method or contact support." Manage "auth/network-request-failed" by displaying "Connection problem detected. Please check your internet connection and try again." Catch "auth/internal-error" or unexpected errors with a fallback message "Something went wrong during sign-in. Please try again or contact customer support if the problem persists."

Manage loading states meticulously throughout the OAuth authentication process to provide clear user feedback. When users click the Google Sign-In button, immediately set a loading state variable (isGoogleLoading) to true, update the button to show Lucide React's Loader2 icon with animate-spin class alongside the text "Signing in...", disable the Google button itself to prevent multiple clicks, disable all other form inputs and buttons to prevent simultaneous authentication attempts, and add a subtle opacity change to the entire form indicating the authentication process is in progress. Ensure the loading state persists until authentication completes and provide appropriate visual feedback throughout the process.

Part 32.4b: Firestore User Management and Data Synchronization
Objective: Implement intelligent user document management in Firestore, handle both new and returning users, and ensure proper profile synchronization with comprehensive cart data merging.

After successful Google authentication (receiving the user credential from signInWithPopup), implement sophisticated user handling logic that differentiates between new and returning users. Extract the authenticated user object from the credential result and immediately check if a corresponding user document exists in Firestore by querying getDoc(doc(db, 'users', user.uid)). Store this document snapshot for subsequent conditional logic determining whether this is a new user registration or existing user login.

For new users completing their first-time Google sign-in (when the Firestore document doesn't exist), create a comprehensive user document at /users/{uid} path with complete profile information. Structure the document with all essential fields maintaining consistency with email/password users: uid from the authenticated user, email extracted from the Google account, displayName from the Google profile, photoURL from the Google profile (user's profile picture), phoneNumber initialized as empty string (to be filled later in profile settings), provider set to "google" indicating authentication method, emailVerified set to true (Google accounts are pre-verified), createdAt using Firestore's serverTimestamp() for accurate server-side timestamp, lastLoginAt also using serverTimestamp(), preferences as an empty object {} for future user customization settings, shippingAddresses as an empty array [] ready for Pakistani address storage, and cartSyncEnabled set to true enabling hybrid persistence.

Use Firestore's setDoc function to create the new user document with proper error handling: await setDoc(doc(db, 'users', user.uid), userData) where userData contains all the structured fields. Wrap this operation in a try-catch block handling potential Firestore errors gracefully, displaying appropriate error messages if document creation fails, and ensuring the user is informed about any issues with a message like "Account created but profile setup incomplete. Please contact support if you experience issues."

For existing users (returning users who have signed in with Google before), implement a focused update flow emphasizing profile synchronization and login tracking. Update the user's lastLoginAt field using updateDoc(doc(db, 'users', user.uid), { lastLoginAt: serverTimestamp() }) to track user activity accurately. Check if the user's Google profile information has changed since their last login by comparing current Google account data with stored Firestore data, updating any changed fields including displayName if the user changed their Google name, photoURL if they updated their Google profile picture, and ensuring these updates happen seamlessly without disrupting the user experience.

Implement sophisticated cart synchronization immediately after user document management, handling the common scenario where users added items to their cart as guests before creating an account. Check localStorage for existing cart data using the key from your cart store (typically cart-storage), parse the stored cart items if they exist, and prepare them for intelligent synchronization with Firestore. Query the user's Firestore cart collection at /users/{uid}/cart to check if they have any existing cart items from previous sessions or devices.

Create intelligent cart merging logic that preserves all user items while handling duplicates appropriately for Pakistani e-commerce context. For each item in the localStorage guest cart, check if the same product exists in the Firestore cart (matching by product ID), and if duplicates exist, use the higher quantity value ensuring users don't lose items they added, preserving user intent and maximizing conversion potential. For unique items (existing only in localStorage or only in Firestore), simply add them to the merged cart maintaining all product details and user selections.

Save the final merged cart to Firestore using batch writes for atomic operations ensuring data consistency. Create a batch write operation, add each cart item as a document in the /users/{uid}/cart collection with structure including productId, quantity, addedAt timestamp, and any product variant information (size, color, etc.), execute the batch write ensuring all cart items are saved together, and handle any Firestore errors during the save operation with appropriate user messaging and retry options optimized for Pakistani network conditions.

Part 32.4c: Post-Registration Success Handling and User Experience Optimization
Objective: Implement comprehensive post-registration success flow including user feedback, intelligent redirects, email verification management, and mobile optimization specifically tailored for Pakistani e-commerce users.

Implement sophisticated post-registration success handling coordinating multiple actions for optimal user experience in the Pakistani market context. Display a success toast notification using shadcn's toast function with a welcoming message specifically crafted for Pakistani users: "Welcome to [Store Name]! Your account has been created successfully. You can now enjoy free delivery on orders over Rs. 2,000, cash on delivery across Pakistan, and exclusive member benefits." Style the toast with success colors (green background, white text), include a success icon (Lucide React's CheckCircle), and ensure it displays for sufficient duration (4-5 seconds) allowing users to read the complete message.

Display a notification about cart synchronization if items were merged, showing a contextual message like "We've saved your cart items to your account! You have [X] items ready for checkout with cash on delivery available." Use a toast notification with a link to view the cart, helping users understand their cart has been preserved and encouraging them to complete their purchase. Clear the localStorage cart data after successful synchronization to prevent duplicate items in future sessions and maintain clean data management.

Implement intelligent redirect logic enhancing user experience based on their journey to the registration page, optimized for Pakistani e-commerce conversion patterns. Use wouter's useLocation and useSearch hooks to check URL search parameters for a redirect destination (typically set when users tried to access protected routes like checkout), extract the redirect URL from the query parameter (commonly ?redirect=/checkout or ?returnTo=/profile), validate the redirect URL ensuring it's within your application domain (preventing open redirect vulnerabilities) by checking if the URL starts with / or matches your domain, and navigate the user to their intended destination if a valid redirect parameter exists.

If no redirect parameter exists, implement smart default redirect logic based on registration context and Pakistani user behavior patterns. Redirect users who had items in their cart to the cart page encouraging purchase completion with prominent COD messaging, redirect users who came from a product page back to that product page maintaining shopping momentum, or redirect to a personalized welcome page highlighting key Pakistani market benefits like nationwide COD, easy returns, and customer support contact information. Consider implementing a brief welcome tour showing key features relevant to Pakistani users: free delivery threshold (Rs. 2,000), COD availability across major cities, WhatsApp customer support, and order tracking capabilities.

Add comprehensive email verification management specifically for email/password users (Google users are pre-verified). Immediately after successful registration with email/password, automatically send a verification email using Firebase's sendEmailVerification(auth.currentUser) function wrapped in a try-catch block handling potential sending failures. Display a prominent banner message: "Please verify your email address. We've sent a verification link to [user's email]. Don't forget to check your spam folder if you don't see it within a few minutes."

Implement a resend verification email option with intelligent rate limiting to prevent abuse while maintaining user convenience. Create a clickable link or button labeled "Resend verification email" with sophisticated rate limiting tracking the last time a verification email was sent using component state or localStorage. Disable the resend button for 60 seconds after each send attempt, show a countdown timer indicating when resend will be available, and display a success message "Verification email sent! Please check your inbox and spam folder" after each successful resend operation.

Ensure comprehensive mobile optimization throughout the entire registration and post-registration process, specifically tailored for Pakistani mobile internet conditions. Use appropriate inputMode attributes on all form inputs: inputMode="email" for email fields triggering the email-optimized keyboard, inputMode="text" for name fields showing the default keyboard with proper capitalization, and inputMode="tel" for future phone number fields showing the numeric keypad. Implement adequate touch target sizes (minimum 44x44px) for all interactive elements including buttons, checkboxes, links, and social authentication buttons ensuring comfortable touch interaction on mobile devices.

Add smooth animations between form states using CSS transitions for a polished mobile experience optimized for various Android devices common in Pakistan. Animate form field focus states with subtle border color transitions, implement smooth page transitions when redirecting after registration using fade effects, add loading state animations with skeleton screens or spinners providing clear visual feedback, and ensure all animations are performant on lower-end Android devices by using CSS transforms and opacity changes rather than layout-triggering properties.

Test thoroughly on various mobile devices and screen sizes ensuring consistent functionality across the diverse range of devices used in Pakistan. Verify functionality on small phones (320px width), medium phones (375px-414px width), large phones (428px+ width), and tablets (768px+ width). Test on both iOS and Android devices, checking for platform-specific issues with keyboard behavior, input focus, and authentication popups. Optimize for slower network connections by implementing appropriate loading states showing progress during authentication, providing retry mechanisms for failed operations with clear error messages, caching user data locally when possible to reduce network dependency, and using optimistic UI updates where appropriate.

Implementation Guidelines for Part 32.4 (All Sections)
Sequential Development: Complete these sub-parts in exact order as each builds upon previous functionality. Part 32.4a establishes Google Sign-In UI and authentication flow, Part 32.4b handles comprehensive user document management and cart synchronization, and Part 32.4c implements success handling and user experience optimization.

Testing Strategy: After each sub-part, conduct thorough testing across Pakistani market conditions: verify Google Sign-In button appears correctly with proper branding and works across different browsers, test authentication flow with various scenarios including successful login, popup blocking, and network interruptions, confirm user documents are created correctly in Firestore for new users and updated appropriately for returning users, validate cart synchronization merges items intelligently without data loss, ensure redirect logic works correctly from various entry points, test email verification flow for email/password users with resend functionality, and verify mobile optimization across different devices and network conditions common in Pakistan.

Pakistani Market Optimization: Maintain consistent focus on local user needs throughout implementation: provide clear messaging about COD availability and free delivery in success notifications, ensure authentication works reliably on slower mobile networks, optimize for mobile devices as the primary internet access method, include customer support contact information (WhatsApp number, phone number) for users experiencing authentication issues, and build trust through clear communication about data security and privacy throughout the registration process.

Performance and Reliability: Optimize for performance and reliability in Pakistani network conditions by implementing request timeouts preventing indefinite loading states, using Firestore offline persistence allowing app functionality during brief disconnections, caching user profile data locally reducing repeated Firestore queries, implementing exponential backoff for retry logic preventing server overload, and providing clear feedback during all loading states ensuring users understand the application is working even on slow connections.